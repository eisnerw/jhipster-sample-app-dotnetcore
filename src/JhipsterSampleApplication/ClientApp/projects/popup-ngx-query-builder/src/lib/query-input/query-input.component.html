<div class="query-input" [class.editing]="editing">
  <button pButton icon="pi pi-search" class="search-btn" (click)="clickSearch()"></button>

  @if (!editing) {
    <div class="text" (click)="startEdit()">
      <span [ngClass]="{ placeholder: !query }">{{ query || placeholder }}</span>
      @if (query) {
        <i class="pi pi-times clear-icon" (click)="clearQuery($event)"></i>
      }
    </div>
  }
  @if (editing) {
    <p-autoComplete
      #editBox
      [(ngModel)]="query"
      [suggestions]="autocompleteSuggestions"
      (completeMethod)="onInputChange($event)"
      (onSelect)="onSuggestionSelect($event)"
      (ngModelChange)="onModelChange($event)"
      (keydown.enter)="onEnter($event)"
      (keydown.arrowup)="onAutocompleteKeydown($any($event))"
      (keydown.arrowdown)="onAutocompleteKeydown($any($event))"
      (keydown.escape)="onAutocompleteKeydown($any($event))"
      (keydown.tab)="onAutocompleteKeydown($any($event))"
      (onBlur)="onInputBlur()"
      [dropdown]="false"
      [forceSelection]="false"
      [ngClass]="{ invalid: !validQuery }"
      [inputStyle]="{ flex: '1', border: 'none', outline: 'none', padding: '4px' }"
    >
      <ng-template let-suggestion pTemplate="item">
        <div class="autocomplete-item">
          <span class="suggestion-value">
            {{ suggestion.display }}
            @if (suggestion.metadata?.description) {
              <span class="suggestion-desc">({{ suggestion.metadata.description }})</span>
            }
          </span>
        </div>
      </ng-template>
    </p-autoComplete>
  }

  @if (editing) {
    <div class="btn-group">
      <i class="pi pi-times action-icon" (click)="cancelEdit()"></i>
      <i class="pi pi-check action-icon" (click)="acceptEdit()" [ngClass]="{ disabled: !validQuery }"></i>
    </div>
  }
</div>

<p-dialog
  [(visible)]="showBuilder"
  [modal]="true"
  [closable]="true"
  [draggable]="true"
  [resizable]="true"
  [maximizable]="true"
  header="Query Builder"
  [style]="{
    width: '800px',
    height: '600px',
    minWidth: '600px',
    minHeight: '400px',
  }"
  [contentStyle]="{
    height: 'calc(100% - 120px)',
    overflow: 'auto',
    padding: '0',
  }"
  styleClass="query-builder-dialog"
  [baseZIndex]="10000"
>
  <ngx-query-builder
    #builder
    [(ngModel)]="builderQuery"
    [config]="queryBuilderConfig"
    [spec]="spec"
    [allowNot]="allowNot"
    [allowConvertToRuleset]="allowConvertToRuleset"
    [allowRuleUpDown]="allowRuleUpDown"
    [ruleName]="ruleName"
    [rulesetName]="rulesetName"
    [defaultRuleAttribute]="defaultRuleAttribute"
  ></ngx-query-builder>

  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <button pButton label="Cancel" (click)="cancelQuery()" class="p-button-secondary"></button>
      <button pButton label="Apply" (click)="applyQuery()" class="p-button-primary" [disabled]="builder?.namingRuleset"></button>
    </div>
  </ng-template>
</p-dialog>
