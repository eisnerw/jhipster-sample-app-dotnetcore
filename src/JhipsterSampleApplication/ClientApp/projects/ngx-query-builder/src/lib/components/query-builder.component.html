@if (
  {
    ruleset: isRuleset(data),
    invalidEmpty: !config.allowEmptyRulesets && isEmptyRuleset(data),
    invalid: isRulesetInvalid(data),
  };
  as local
) {
  <div [ngClass]="getQueryRulesetClassName(local)">
    <div [ngClass]="getClassNames('switchRow')">
      @if (allowCollapse) {
        <a (click)="toggleCollapse()" [ngClass]="getClassNames('arrowIconButton', collapsed ? 'collapsed' : null)">
          <ng-template [ngTemplateOutlet]="_arrowIconTpl" />
        </a>
      }
      <ng-template [ngTemplateOutlet]="_switchGroupTpl" />
      @if (namingRuleset === data) {
        <span class="q-name-edit">
          <input [(ngModel)]="namingRulesetName" class="q-name-input" (input)="onNamingInput($event)" />
          <button type="button" (click)="confirmNamingRuleset()" [ngClass]="getClassNames('button')">✓</button>
          <button type="button" (click)="cancelNamingRuleset()" [ngClass]="getClassNames('button')">✕</button>
        </span>
      }
      @if (!data.name && config.saveNamedRuleset && !isRulesetInvalid(data) && namingRuleset !== data) {
        <span class="q-name-text" (click)="startNamingRuleset(data)">Click to name {{ rulesetName }}</span>
      }
      @if (data.name && config.getNamedRuleset && config.saveNamedRuleset && config.deleteNamedRuleset) {
        <div class="q-name-wrapper">
          <button
            type="button"
            class="q-name-action"
            (click)="namedRulesetAction(data)"
            [ngClass]="getClassNames('button')"
            [class.q-name-action-modified]="namedRulesetModified(data)"
            [disabled]="disabled"
            [title]="namedRulesetModified(data) ? rulesetName + ' has been modified needs to be saved, renamed or unnamed' : null"
          >
            <i [ngClass]="getClassNames(namedRulesetModified(data) ? 'saveIcon' : 'searchIcon')"></i>
            <span class="q-name-label" [ngClass]="{ 'q-name-modified': namedRulesetModified(data) }">{{ data.name }}</span>
          </button>
          <button
            type="button"
            class="q-name-remove"
            (click)="removeRulesetName(data)"
            [title]="'Remove ' + rulesetName + ' name'"
            [disabled]="disabled"
          >
            ✕
          </button>
        </div>
      }
      @if (collapsed && config.customCollapsedSummary) {
        <span [ngClass]="getClassNames('collapsedSummary')">
          {{ config.customCollapsedSummary(data) }}
        </span>
      }
      <ng-template [ngTemplateOutlet]="_buttonGroupTpl" />
    </div>
    <div [ngClass]="getClassNames('treeContainer', collapsed ? 'collapsed' : null)" (transitionend)="transitionEnd()" #treeContainer>
      @if (data && data.rules) {
        <ul [ngClass]="getClassNames('tree')">
          @for (rule of data.rules; track (isRuleset(rule) ? (rule.name || rule) : (rule.field + '|' + rule.operator + '|' + (rule.entity || ''))); let i = $index) {
            @if (!config.rulesLimit || i < config.rulesLimit) {
              @if (isRule(rule) || !config.levelLimit || level + 1 < config.levelLimit) {
                <li [ngClass]="getQueryItemClassName()">
                  @if (isRule(rule)) {
                    <div [ngClass]="getQueryRuleClassName()">
                      <div [ngClass]="getClassNames('ruleContent')">
                        @if (entities && entities.length > 0) {
                          <div class="q-inline-block-display">
                            <ng-template
                              [ngTemplateOutlet]="_entityTpl"
                              [ngTemplateOutletContext]="{
                                $implicit: rule,
                                index: i,
                              }"
                            />
                          </div>
                        }
                        <ng-template [ngTemplateOutlet]="_fieldTpl" [ngTemplateOutletContext]="{ $implicit: rule }" />
                        <ng-template [ngTemplateOutlet]="_operatorTpl" [ngTemplateOutletContext]="{ $implicit: rule }" />
                        <ng-template [ngTemplateOutlet]="_inputTpl" [ngTemplateOutletContext]="{ $implicit: rule }" />
                      </div>
                      <div [ngClass]="getClassNames('ruleActions')" class="q-button-wrapper" [class.q-hide-buttons]="hideButtons">
                        @if (hideButtons) {
                          <span class="q-ellipsis">&hellip;</span>
                        }
                        @if (isRuleInvalid(rule, data)) {
                          <span class="q-invalid-message">Invalid {{ ruleName }}</span>
                        }
                        <div class="q-buttons">
                          @if (allowRuleUpDown && data.rules.length > 1) {
                            <button
                              type="button"
                              (click)="moveRuleUp(rule, data)"
                              [ngClass]="getClassNames('button')"
                              [disabled]="disabled || i === 0"
                            >
                              <i [ngClass]="getClassNames('upIcon')"></i>
                            </button>
                          }
                          @if (allowRuleUpDown && data.rules.length > 1) {
                            <button
                              type="button"
                              (click)="moveRuleDown(rule, data)"
                              [ngClass]="getClassNames('button')"
                              [disabled]="disabled || i === data.rules.length - 1"
                            >
                              <i [ngClass]="getClassNames('downIcon')"></i>
                            </button>
                          }
                          @if (allowConvertToRuleset) {
                            <button
                              type="button"
                              (click)="convertToRuleset(rule, data)"
                              [title]="'Convert to a ' + rulesetName + ' containing this ' + ruleName"
                              [ngClass]="getClassNames('button')"
                              [disabled]="disabled"
                            >
                              <svg [ngClass]="getClassNames('equalIcon')" width="12" height="12" viewBox="0 0 12 12" aria-hidden="true">
                                <path d="M1 3h10v2H1zM1 7h10v2H1z" />
                              </svg>
                              {{ rulesetName }}
                            </button>
                          }
                          <ng-template [ngTemplateOutlet]="_ruleRemoveButtonTpl" [ngTemplateOutletContext]="{ $implicit: rule }" />
                        </div>
                      </div>
                    </div>
                  }
                  @if (isRuleset(rule)) {
                    <ngx-query-builder
                      [data]="rule"
                      [level]="level + 1"
                      [disabled]="disabled"
                      [parentTouchedCallback]="parentTouchedCallback || onTouchedCallback"
                      [parentChangeCallback]="parentChangeCallback || onChangeCallback"
                      [parentInputTemplates]="parentInputTemplates || inputTemplates"
                      [parentOperatorTemplate]="parentOperatorTemplate || operatorTemplate"
                      [parentFieldTemplate]="parentFieldTemplate || fieldTemplate"
                      [parentEntityTemplate]="parentEntityTemplate || entityTemplate"
                      [parentSwitchGroupTemplate]="parentSwitchGroupTemplate || switchGroupTemplate"
                      [parentButtonGroupTemplate]="parentButtonGroupTemplate || buttonGroupTemplate"
                      [parentRulesetAddRuleButtonTemplate]="parentRulesetAddRuleButtonTemplate || rulesetAddRuleButtonTemplate"
                      [parentRulesetAddRulesetButtonTemplate]="parentRulesetAddRulesetButtonTemplate || rulesetAddRulesetButtonTemplate"
                      [parentRulesetRemoveButtonTemplate]="parentRulesetRemoveButtonTemplate || rulesetRemoveButtonTemplate"
                      [parentRuleRemoveButtonTemplate]="parentRuleRemoveButtonTemplate || ruleRemoveButtonTemplate"
                      [parentEmptyWarningTemplate]="parentEmptyWarningTemplate || emptyWarningTemplate"
                      [parentArrowIconTemplate]="parentArrowIconTemplate || arrowIconTemplate"
                      [parentValue]="data"
                      [classNames]="classNames"
                      [config]="config"
                      [allowRuleset]="allowRuleset"
                      [allowCollapse]="allowCollapse"
                      [allowNot]="allowNot"
                      [allowConvertToRuleset]="allowConvertToRuleset"
                      [allowRuleUpDown]="allowRuleUpDown"
                      [ruleName]="ruleName"
                      [rulesetName]="rulesetName"
                      [hideButtons]="hideButtons"
                      [emptyMessage]="emptyMessage"
                      [operatorMap]="operatorMap"
                    >
                    </ngx-query-builder>
                  }
                </li>
              }
            }
          }
        </ul>
      }
      <ng-template [ngTemplateOutlet]="_emptyWarningTpl" [ngTemplateOutletContext]="{ $implicit: local }" />
    </div>
  </div>
}

<!--_arrowIconTpl-->
<ng-template #_arrowIconTpl>
  @if (getArrowIconTemplate(); as template) {
    <ng-container *ngTemplateOutlet="template; context: getArrowIconContext()"></ng-container>
  } @else {
    <i [ngClass]="getClassNames('arrowIcon')"></i>
  }
</ng-template>

<!--_switchGroupTpl-->
<ng-template #_switchGroupTpl>
  @if (getSwitchGroupTemplate(); as template) {
    <ng-container *ngTemplateOutlet="template; context: getSwitchGroupContext()"></ng-container>
  } @else {
    @if (data) {
      <div
        [ngClass]="getClassNames('switchGroup', 'transition')"
        (mouseenter)="hoveringSwitchGroup = true"
        (mouseleave)="hoveringSwitchGroup = false"
      >
        @if (allowNot && (data.not || hoveringSwitchGroup)) {
          <div [ngClass]="getClassNames('switchControl')">
            <input
              type="checkbox"
              [ngClass]="getClassNames('switchRadio')"
              [(ngModel)]="data.not"
              (ngModelChange)="changeNot($event)"
              [disabled]="disabled"
            />
            <label (click)="changeNot(!data.not)" [ngClass]="getClassNames('switchLabel')"> NOT </label>
          </div>
        }
        @if (data.condition === 'and' || hoveringSwitchGroup) {
          <div [ngClass]="getClassNames('switchControl')">
            <input
              type="radio"
              [ngClass]="getClassNames('switchRadio')"
              [(ngModel)]="data.condition"
              [disabled]="disabled"
              value="and"
              #andOption
            />
            <label (click)="changeCondition(andOption.value)" [ngClass]="getClassNames('switchLabel')">
              @if (hoveringSwitchGroup || data.rules.length !== 1) {
                AND
              } @else {
                <span class="q-switch-label-empty">&nbsp;</span>
              }
            </label>
          </div>
        }
        @if (data.condition === 'or' || hoveringSwitchGroup) {
          <div [ngClass]="getClassNames('switchControl')">
            <input
              type="radio"
              [ngClass]="getClassNames('switchRadio')"
              [(ngModel)]="data.condition"
              [disabled]="disabled"
              value="or"
              #orOption
            />
            <label (click)="changeCondition(orOption.value)" [ngClass]="getClassNames('switchLabel')">
              @if (hoveringSwitchGroup || data.rules.length !== 1) {
                OR
              } @else {
                <span class="q-switch-label-empty">&nbsp;</span>
              }
            </label>
          </div>
        }
      </div>
    }
  }
</ng-template>

<!--_buttonGroupTpl-->
<ng-template #_buttonGroupTpl>
  @if (getButtonGroupTemplate(); as template) {
    <div [ngClass]="getClassNames('buttonGroup', 'rightAlign')">
      <ng-container *ngTemplateOutlet="template; context: getButtonGroupContext()"></ng-container>
    </div>
  } @else {
    <div [ngClass]="getClassNames('buttonGroup', 'rightAlign')" class="q-button-wrapper" [class.q-hide-buttons]="hideButtons">
      @if (hideButtons) {
        <span class="q-ellipsis">&hellip;</span>
      }
      @if (isRulesetInvalid(data)) {
        <span class="q-invalid-message">Invalid {{ rulesetName }}</span>
      }
      <div class="q-buttons">
        @if (!config.rulesLimit || data.rules.length < config.rulesLimit) {
          <ng-container *ngTemplateOutlet="_rulesetAddRuleButtonTpl"></ng-container>
          @if (!config.levelLimit || level + 1 < config.levelLimit) {
            <ng-container *ngTemplateOutlet="_rulesetAddRulesetButtonTpl"></ng-container>
          }
          @if (config.listNamedRulesets && config.getNamedRuleset) {
            <button type="button" (click)="addNamedRuleSet()" [ngClass]="getClassNames('button')" [disabled]="disabled">
              <i [ngClass]="getClassNames('addIcon')"></i> Named
              {{ rulesetName }}
            </button>
          }
        }
        @if (allowRuleUpDown && parentValue && parentValue.rules.length > 1) {
          <button
            type="button"
            (click)="moveRuleUp(data, parentValue)"
            [ngClass]="getClassNames('button')"
            [disabled]="disabled || parentValue.rules[0] === data"
          >
            <i [ngClass]="getClassNames('upIcon')"></i>
          </button>
          <button
            type="button"
            (click)="moveRuleDown(data, parentValue)"
            [ngClass]="getClassNames('button')"
            [disabled]="disabled || parentValue.rules[parentValue.rules.length - 1] === data"
          >
            <i [ngClass]="getClassNames('downIcon')"></i>
          </button>
        }
        @if (allowConvertToRuleset && parentValue && data.rules.length === 1) {
          <button
            type="button"
            (click)="convertRulesetToRule(data, parentValue)"
            [title]="'Embed this  ' + ruleName + ' in it\s parent\'s ' + rulesetName"
            [ngClass]="getClassNames('button')"
            [disabled]="disabled"
          >
            <svg [ngClass]="getClassNames('equalIcon')" width="12" height="12" viewBox="0 0 12 12" aria-hidden="true">
              <path d="M1 3h10v2H1zM1 7h10v2H1z" />
            </svg>
            {{ ruleName }}
          </button>
        }
        @if (allowConvertToRuleset) {
          <button
            type="button"
            (click)="wrapRuleset(data, parentValue)"
            [title]="'Wrap this ' + rulesetName + ' in another ' + rulesetName"
            [ngClass]="getClassNames('button')"
            [disabled]="disabled"
          >
            <svg [ngClass]="getClassNames('equalIcon')" width="12" height="12" viewBox="0 0 12 12" aria-hidden="true">
              <path d="M1 3h10v2H1zM1 7h10v2H1z" />
            </svg>
            {{ rulesetName }}
          </button>
        }
        @if (!!parentValue) {
          <ng-container *ngTemplateOutlet="_rulesetRemoveButtonTpl"></ng-container>
        }
      </div>
    </div>
  }
</ng-template>

<!--_rulesetAddRuleButtonTpl-->
<ng-template #_rulesetAddRuleButtonTpl let-rule>
  @if (getRulesetAddRuleButtonTemplate(); as template) {
    <ng-container *ngTemplateOutlet="template; context: getRulesetAddRuleButtonContext(rule)"></ng-container>
  } @else {
    <button type="button" (click)="addRule()" [ngClass]="getClassNames('button')" [disabled]="disabled">
      <i [ngClass]="getClassNames('addIcon')"></i> {{ ruleName }}
    </button>
  }
</ng-template>

<!--_rulesetAddRulesetButtonTpl-->
<ng-template #_rulesetAddRulesetButtonTpl let-rule>
  @if (getRulesetAddRulesetButtonTemplate(); as template) {
    <ng-container *ngTemplateOutlet="template; context: getRulesetAddRulesetButtonContext(rule)"></ng-container>
  } @else {
    @if (allowRuleset) {
      <button type="button" (click)="addRuleSet()" [ngClass]="getClassNames('button')" [disabled]="disabled">
        <i [ngClass]="getClassNames('addIcon')"></i> {{ rulesetName }}
      </button>
    }
  }
</ng-template>

<!--_rulesetRemoveButtonTpl-->
<ng-template #_rulesetRemoveButtonTpl let-rule>
  @if (getRulesetRemoveButtonTemplate(); as template) {
    <ng-container *ngTemplateOutlet="template; context: getRulesetRemoveButtonContext(rule)"></ng-container>
  } @else {
    <button type="button" (click)="removeRuleSet()" [ngClass]="getClassNames('button', 'removeButton')" [disabled]="disabled">
      <i [ngClass]="getClassNames('removeIcon')"></i>
    </button>
  }
</ng-template>

<!--_entityTpl-->
<ng-template #_entityTpl let-rule let-index="index">
  @if (getEntityTemplate(); as template) {
    <ng-container *ngTemplateOutlet="template; context: getEntityContext(rule)"></ng-container>
  } @else {
    <div [ngClass]="getClassNames('entityControlSize')">
      <select
        [ngClass]="getClassNames('entityControl')"
        [(ngModel)]="rule.entity"
        (ngModelChange)="changeEntity($event, rule, index, data)"
        [disabled]="disabled"
      >
        @for (entity of entities; track entity.value || entity.name) {
          <option [ngValue]="entity.value">
            {{ entity.name }}
          </option>
        }
      </select>
    </div>
  }
</ng-template>

<!--_fieldTpl-->
<ng-template #_fieldTpl let-rule>
  @if (getFieldTemplate(); as template) {
    <ng-container *ngTemplateOutlet="template; context: getFieldContext(rule)"></ng-container>
  } @else {
    <div [ngClass]="getClassNames('fieldControlSize')">
      <select
        [ngClass]="getClassNames('fieldControl')"
        [(ngModel)]="rule.field"
        (ngModelChange)="changeField($event, rule)"
        [disabled]="disabled"
      >
        @for (field of getFields(rule.entity || ''); track field.value || field.name) {
          <option [ngValue]="field.value">
            {{ field.name }}
          </option>
        }
      </select>
    </div>
  }
</ng-template>

<!--_operatorTpl-->
<ng-template #_operatorTpl let-rule>
  @if (getOperatorTemplate(); as template) {
    <ng-container *ngTemplateOutlet="template; context: getOperatorContext(rule)"></ng-container>
  } @else {
    <div [ngClass]="getClassNames('operatorControlSize')">
      <select
        [ngClass]="getClassNames('operatorControl')"
        [(ngModel)]="rule.operator"
        (ngModelChange)="changeOperator(rule)"
        [disabled]="disabled"
      >
        @for (operator of getOperators(rule.field); track operator) {
          <option [ngValue]="operator">
            {{ operator }}
          </option>
        }
      </select>
    </div>
  }
</ng-template>

<!--_inputTpl-->
<ng-template #_inputTpl let-rule>
  @if (findTemplateForRule(rule); as template) {
    <ng-container *ngTemplateOutlet="template; context: getInputContext(rule, data)"></ng-container>
  } @else {
    <div [ngClass]="getClassNames('inputControlSize')">
      @switch (getInputType(rule.field, rule.operator || '')) {
        @case ('string') {
          <input
            [ngClass]="getClassNames('inputControl')"
            [(ngModel)]="rule.value"
            (ngModelChange)="changeInput()"
            [disabled]="disabled"
            type="text"
          />
        }
        @case ('number') {
          <input
            [ngClass]="getClassNames('inputControl')"
            [(ngModel)]="rule.value"
            (ngModelChange)="changeInput()"
            [disabled]="disabled"
            type="number"
          />
        }
        @case ('date') {
          <input
            [ngClass]="getClassNames('inputControl')"
            [(ngModel)]="rule.value"
            (ngModelChange)="changeInput()"
            [disabled]="disabled"
            type="date"
          />
        }
        @case ('time') {
          <input
            [ngClass]="getClassNames('inputControl')"
            [(ngModel)]="rule.value"
            (ngModelChange)="changeInput()"
            [disabled]="disabled"
            type="time"
          />
        }
        @case ('category') {
          <select [ngClass]="getClassNames('inputControl')" [(ngModel)]="rule.value" (ngModelChange)="changeInput()" [disabled]="disabled">
            @for (opt of getOptions(rule.field, rule, data); track (opt.value ?? opt.name)) {
              <option [ngValue]="opt.value">
                {{ opt.name }}
              </option>
            }
          </select>
        }
        @case ('multiselect') {
          @if ((getOptions(rule.field, rule, data) || []).length > 0) {
            <select
              [ngClass]="getClassNames('inputControl')"
              [(ngModel)]="rule.value"
              (ngModelChange)="changeInput()"
              [disabled]="disabled"
              multiple
            >
              @for (opt of getOptions(rule.field, rule, data); track (opt.value ?? opt.name)) {
                <option [ngValue]="opt.value">
                  {{ opt.name }}
                </option>
              }
            </select>
          } @else {
            <div [ngClass]="getClassNames('inputControl')" class="q-chip-input">
              @for (tok of (rule.value || []); track tok; let i = $index) {
                <span class="q-chip">
                  {{ tok }}
                  <button type="button" class="q-chip-remove" (click)="removeToken(rule, i)" [disabled]="disabled">×</button>
                </span>
              }
              <input
                type="text"
                class="q-chip-text"
                [disabled]="disabled"
                (keydown)="onTokenKeydown($event, rule)"
                (blur)="onTokenBlur($event, rule)"
                placeholder="Add value"
              />
            </div>
          }
        }
        @case ('boolean') {
          <input
            [ngClass]="getClassNames('inputControl')"
            [(ngModel)]="rule.value"
            (ngModelChange)="changeInput()"
            [disabled]="disabled"
            type="checkbox"
          />
        }
      }
    </div>
  }
</ng-template>

<!--_ruleRemoveButtonTpl-->
<ng-template #_ruleRemoveButtonTpl let-rule>
  @if (getRuleRemoveButtonTemplate(); as template) {
    <div [ngClass]="getClassNames('buttonGroup', 'rightAlign')">
      <ng-container *ngTemplateOutlet="template; context: getRuleRemoveButtonContext(rule)"></ng-container>
    </div>
  } @else {
    <div [ngClass]="getClassNames('removeButtonSize', 'rightAlign')">
      <button type="button" [ngClass]="getClassNames('button', 'removeButton')" (click)="removeRule(rule, data)" [disabled]="disabled">
        <i [ngClass]="getClassNames('removeIcon')"></i>
      </button>
    </div>
  }
</ng-template>

<!--_emptyWarningTpl-->
<ng-template #_emptyWarningTpl let-local>
  @if (getEmptyWarningTemplate(); as template) {
    @if (local.invalidEmpty) {
      <ng-container *ngTemplateOutlet="template; context: getEmptyWarningContext()"></ng-container>
    }
  } @else {
    @if (local.invalidEmpty) {
      <p [ngClass]="getClassNames('emptyWarning')">
        {{ emptyMessage }}
      </p>
    }
  }
</ng-template>
