<!-- super-table.component.html -->
@if (dataLoader && mode === 'grid') {
  <p-table
    #pTable
    [value]="(dataLoader.data$ | async)!"
    [columns]="visibleColumns"
    dataKey="id"
    [rowTrackBy]="trackByFn"
    [lazy]="false"
    [virtualScroll]="false"
    [resizableColumns]="false"
    columnResizeMode="expand"
    [reorderableColumns]="reorderableColumns"
    [scrollable]="scrollable"
    [scrollHeight]="scrollHeight"
    [tableStyle]="tableStyle"
    [paginator]="paginator"
    [showGridlines]="true"
    [globalFilterFields]="globalFilterFields"
    (onSort)="handleSort($event)"
    (onFilter)="handleFilter($event)"
    (onColResize)="onColResize.emit($event)"
    expandableRow
    [expandedRowKeys]="expandedRowKeys"
    (onRowExpand)="onRowExpand($event)"
    (onRowCollapse)="onRowCollapse($event)"
    [selectionMode]="selectionMode"
    [(selection)]="selection"
    (selectionChange)="selectionChange.emit($event)"
    [contextMenu]="contextMenu"
    [(contextMenuSelection)]="contextMenuSelection"
    (onContextMenuSelect)="onContextMenuSelect.emit($event)"
    (contextMenuSelectionChange)="contextMenuSelectionChange.emit($event)"
  >
    <ng-template pTemplate="colgroup" let-columns>
      <colgroup>
        @for (col of columns; track col; let i = $index) {
          <col [style.width]="col.width" />
        }
      </colgroup>
    </ng-template>
    @if (showHeader && !superTableParent) {
      <ng-template pTemplate="header" let-columns>
        <tr class="header-row">
          @for (col of columns; track col; let i = $index) {
            <th
              [pSortableColumn]="
                col.type === 'string' || col.type === 'date' || col.type === 'boolean' || col.type === 'list' ? col.field : null
              "
              [style.width]="col.width"
              [style]="col.style"
              [ngClass]="{ 'numeric-header': col.filterType === 'numeric' }"
            >
              <div class="header-cell">
                <span class="header-text">{{ col.header }}</span>
                @switch (col.type) {
                  @case ('string') {
                    <p-sortIcon class="sort-icon" [field]="col.field"></p-sortIcon>
                    @if (col.filterType) {
                      <p-columnFilter class="filter-button" [field]="col.field" [type]="col.filterType" display="menu"> </p-columnFilter>
                    }
                  }
                  @case ('date') {
                    <p-sortIcon class="sort-icon" [field]="col.field"></p-sortIcon>
                    @if (col.filterType) {
                      <p-columnFilter class="filter-button" [field]="col.field" [type]="col.filterType" display="menu"> </p-columnFilter>
                    }
                  }
                  @case ('boolean') {
                    <p-sortIcon class="sort-icon" [field]="col.field"></p-sortIcon>
                    @if (col.filterType) {
                      <p-columnFilter class="filter-button" [field]="col.field" [type]="col.filterType" display="menu"> </p-columnFilter>
                    }
                  }
                  @case ('list') {
                    <p-sortIcon class="sort-icon" [field]="col.field"></p-sortIcon>
                    <p-columnFilter
                      class="filter-button"
                      [field]="col.field"
                      matchMode="in"
                      display="menu"
                      [showMatchModes]="false"
                      [showOperator]="false"
                      [showAddButton]="false"
                    >
                      <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                        <p-multiselect
                          [options]="col.listOptions"
                          placeholder="Any"
                          (onChange)="filterList($event, col.field)"
                          optionLabel="label"
                          [style]="{ 'min-width': '14rem' }"
                          [panelStyle]="{ 'min-width': '16rem' }"
                          [showToggleAll]="true"
                          [showClear]="true"
                        >
                        </p-multiselect>
                      </ng-template>
                    </p-columnFilter>
                  }
                  @case ('checkbox') {
                    <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                  }
                  @case ('expander') {
                    <span></span>
                  }
                  @case ('lineNumber') {
                    <span></span>
                  }
                }
              </div>
              <span
                class="st-resize-handle"
                *ngIf="resizableColumns && (col.type === 'string' || col.type === 'date' || col.type === 'boolean' || col.type === 'list')"
                (mousedown)="onResizeStart(i, $event)"
                (mouseup)="$event.stopPropagation()"
                (click)="$event.stopPropagation()"
                (dblclick)="$event.stopPropagation()"
              ></span>
            </th>
          }
        </tr>
        @if (dataLoader.loading$ | async) {
          <tr class="loading-row">
            <td [attr.colspan]="visibleColumns.length">
              {{ dataLoader.loadingMessage$ | async }}
            </td>
          </tr>
        }
      </ng-template>
    }
    <ng-template pTemplate="body" let-rowData let-columns="columns" let-rowIndex="rowIndex">
      <tr [pContextMenuRow]="rowData">
        @for (col of columns; track col; let i = $index) {
          <td
            [ngClass]="{ 'numeric-cell': col.filterType === 'numeric' }"
            [attr.data-catcount]="(((i === 0 && col.type !== 'checkbox' && col.type !== 'lineNumber') || (i === 1 && (columns[0]?.type === 'checkbox' || columns[0]?.type === 'lineNumber'))) && (rowData.categories?.length || 0) > 0) ? rowData.categories.length : null"
          >
            @switch (col.type) {
              @case ('checkbox') {
                <p-tableCheckbox [value]="rowData" dataKey="id"></p-tableCheckbox>
              }
              @case ('string') {
                @if ((((i === 0) && (col.type !== 'checkbox' && col.type !== 'lineNumber')) ||
                      ((i === 1) && ((columns[0]?.type === 'checkbox' || columns[0]?.type === 'lineNumber'))))
                      && (rowData.categories?.length || 0) > 0) {
                  <span class="cat-pill"
                        [pTooltip]="(rowData.categories || []).join(', ')"
                        tooltipPosition="right"
                        appendTo="body"
                        [tooltipStyleClass]="'cat-tooltip'">
                    {{ rowData.categories.length }}
                  </span>
                }
                <span class="cell-content" [pTooltip]="getCellString(rowData, col)" [innerHTML]="formatCell(getCellString(rowData, col), col.field)"></span>
              }
              @case ('date') {
                <span class="cell-content">
                  {{ nonEmpty(rowData[col.field]) ? (rowData[col.field] | date: (col.dateFormat || 'MM/dd/yyyy')) : '' }}
                </span>
              }
              @case ('boolean') {
                <span class="cell-content" [pTooltip]="rowData[col.field] ? 'Yes' : 'No'">{{ rowData[col.field] ? 'Yes' : 'No' }}</span>
              }
              @case ('list') {
                @if ((((i === 0) && (col.type !== 'checkbox' && col.type !== 'lineNumber')) ||
                      ((i === 1) && ((columns[0]?.type === 'checkbox' || columns[0]?.type === 'lineNumber'))))
                      && (rowData.categories?.length || 0) > 0) {
                  <span class="cat-pill"
                        [pTooltip]="(rowData.categories || []).join(', ')"
                        tooltipPosition="right"
                        appendTo="body"
                        [tooltipStyleClass]="'cat-tooltip'">
                    {{ rowData.categories.length }}
                  </span>
                }
                <span class="cell-content" [pTooltip]="getCellString(rowData, col)" [innerHTML]="formatCell(getCellString(rowData, col), col.field)"></span>
              }
              @case ('lineNumber') {
                <span class="cell-content" [pTooltip]="rowIndex + 1">{{ rowIndex + 1 }}</span>
              }
              @case ('expander') {
                <button
                  pButton
                  [icon]="isRowExpanded(rowData) ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                  [pRowToggler]="rowData"
                  class="p-button-text p-button-rounded p-button-plain"
                  style="width: 2rem; height: 2rem; padding: 0"
                ></button>
              }
            }
          </td>
        }
      </tr>
    </ng-template>
    <ng-template #expandedrow let-rowData>
      <tr>
        <td [attr.colspan]="visibleColumns.length">
          <ng-container *ngIf="expandedRowTemplate; else defaultExpandedRow"
                        [ngTemplateOutlet]="expandedRowTemplate"
                        [ngTemplateOutletContext]="{ $implicit: rowData }">
          </ng-container>
          <ng-template #defaultExpandedRow>
            <div class="p-p-3">
              <p>No expanded row template provided</p>
            </div>
          </ng-template>
        </td>
      </tr>
    </ng-template>
  </p-table>
}
@if (mode === 'group') {
  <p-table
    [columns]="visibleColumns"
    #pTable
    [resizableColumns]="false"
    columnResizeMode="expand"
    [scrollable]="true"
    [scrollHeight]="scrollHeight"
    [tableStyle]="tableStyle"
    [showGridlines]="false"
    [globalFilterFields]="['name']"
    (onSort)="onHeaderSort($event)"
    (onFilter)="onHeaderFilter($event)"
    (onColResize)="onHeaderColResize($event)"
    [value]="displayGroups"
  >
    @if (showHeader && !superTableParent) {
      <ng-template pTemplate="header" let-columns>
        <tr class="header-row">
          @for (col of columns; track col; let i = $index) {
            <th
              [pSortableColumn]="
                col.type === 'string' || col.type === 'date' || col.type === 'boolean' || col.type === 'list' ? col.field : undefined
              "
              [style.width]="col.width"
              [style]="col.style"
              [ngClass]="{ 'numeric-header': col.filterType === 'numeric' }"
            >
              <div class="p-d-flex p-jc-between p-ai-center">
                {{ col.header }}
                @switch (col.type) {
                  @case ('string') {
                    <p-sortIcon [field]="col.field"></p-sortIcon>
                    @if (col.filterType) {
                      <p-columnFilter [field]="col.field" [type]="col.filterType" display="menu"> </p-columnFilter>
                    }
                  }
                  @case ('date') {
                    <p-sortIcon [field]="col.field"></p-sortIcon>
                    @if (col.filterType) {
                      <p-columnFilter [field]="col.field" [type]="col.filterType" display="menu"> </p-columnFilter>
                    }
                  }
                  @case ('boolean') {
                    <p-sortIcon [field]="col.field"></p-sortIcon>
                    @if (col.filterType) {
                      <p-columnFilter [field]="col.field" [type]="col.filterType" display="menu"> </p-columnFilter>
                    }
                  }
                  @case ('list') {
                    <p-sortIcon [field]="col.field"></p-sortIcon>
                    <p-columnFilter
                      [field]="col.field"
                      matchMode="in"
                      display="menu"
                      [showMatchModes]="false"
                      [showOperator]="false"
                      [showAddButton]="false"
                    >
                      <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                        <p-multiselect
                          [options]="col.listOptions"
                          placeholder="Any"
                          (onChange)="filterList($event, col.field)"
                          optionLabel="label"
                          [style]="{ 'min-width': '14rem' }"
                          [panelStyle]="{ 'min-width': '16rem' }"
                          [showToggleAll]="true"
                          [showClear]="true"
                        >
                        </p-multiselect>
                      </ng-template>
                    </p-columnFilter>
                  }
                  @case ('checkbox') {
                    <p-checkbox
                      [binary]="true"
                      [ngModel]="isAllVisibleSelected()"
                      aria-label="Select all visible detail rows"
                      (onChange)="onGroupHeaderSelectAll($event.checked)"
                    ></p-checkbox>
                  }
                  @case ('expander') {
                    <span></span>
                  }
                  @case ('lineNumber') {
                    <span></span>
                  }
                }
              </div>
              <span
                class="st-resize-handle"
                *ngIf="resizableColumns && (col.type === 'string' || col.type === 'date' || col.type === 'boolean' || col.type === 'list')"
                (mousedown)="onResizeStart(i, $event)"
                (mouseup)="$event.stopPropagation()"
                (click)="$event.stopPropagation()"
                (dblclick)="$event.stopPropagation()"
              ></span>
            </th>
          }
        </tr>
      </ng-template>
    }
    <ng-template pTemplate="body" let-rowData>
      <tr class="p-row-odd">
        <td [attr.colspan]="visibleColumns.length">
          <div style="display: flex; align-items: center">
            <span [ngStyle]="getIndentStyle(rowData)"></span>
            <button type="button" pButton class="p-button-text p-button-rounded p-button-plain" (click)="onGroupToggle(rowData)">
              <span class="group-toggle-icon" [class]="isGroupExpanded(rowData) ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></span>
            </button>
            <span class="group-name">{{ rowData.name }}</span>
            <span class="group-count">({{ rowData.count }})</span>
          </div>
        </td>
      </tr>
      @if (isGroupExpanded(rowData)) {
        <tr>
          <td [attr.colspan]="visibleColumns.length">
            <super-table
              #detailTable
              class="grid-table"
              [dataLoader]="groupLoaders[rowData.name]?.loader"
              [groups]="groupLoaders[rowData.name]?.groups || []"
              [mode]="groupLoaders[rowData.name]?.mode || 'grid'"
              [groupQuery]="groupQuery"
              [columns]="visibleColumns"
              [showRowNumbers]="showRowNumbers"
              [superTableParent]="this"
              [parentKey]="rowData.name"
              [expandedRowTemplate]="expandedRowTemplate"
              [resizableColumns]="resizableColumns"
              [scrollable]="scrollable"
              [scrollHeight]="scrollHeight"
              [selectionMode]="selectionMode"
              [selection]="selection"
              (selectionChange)="selectionChange.emit($event)"
              [contextMenu]="contextMenu"
              [contextMenuSelection]="contextMenuSelection"
              (onContextMenuSelect)="onContextMenuSelect.emit($event)"
              (contextMenuSelectionChange)="contextMenuSelectionChange.emit($event)"
              (rowExpand)="rowExpand.emit($event)"
              (rowCollapse)="rowCollapse.emit($event)"
            ></super-table>
          </td>
        </tr>
      }
    </ng-template>
  </p-table>
}
