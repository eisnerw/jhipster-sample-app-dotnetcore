<!-- super-table.component.html -->
<p-table
  *ngIf="dataLoader && mode === 'grid'"
  #pTable
  [value]="(dataLoader.data$ | async)!"
  [columns]="visibleColumns"
  dataKey="id"
  [rowTrackBy]="trackByFn"
  [lazy]="false"
  [virtualScroll]="false"
  [resizableColumns]="resizableColumns"
  columnResizeMode="fit"
  [reorderableColumns]="reorderableColumns"
  [scrollable]="scrollable"
  [scrollHeight]="scrollHeight"
  [paginator]="paginator"
  [showGridlines]="true"
  (onSort)="handleSort($event)"
  (onFilter)="handleFilter($event)"
  (onColResize)="onColResize.emit($event)"
  expandableRow
  [expandedRowKeys]="expandedRowKeys"
  (onRowExpand)="onRowExpand($event)"
  (onRowCollapse)="onRowCollapse($event)"
>
  <ng-template pTemplate="colgroup" let-columns>
    <colgroup>
      <col *ngFor="let col of columns" [style.width]="col.width" />
    </colgroup>
  </ng-template>
  <ng-container *ngIf="showHeader && !superTableParent">
    <ng-template pTemplate="header" let-columns>
      <tr class="header-row">
        <th
          *ngFor="let col of columns"
          [pSortableColumn]="
            col.type === 'string' ||
            col.type === 'date' ||
            col.type === 'boolean' ||
            col.type === 'list'
              ? col.field
              : null
          "
          pResizableColumn
          [style.width]="col.width"
          [style]="col.style"
        >
          <div class="header-cell">
            <span class="header-text">{{ col.header }}</span>
            <ng-container [ngSwitch]="col.type">
              <ng-container *ngSwitchCase="'string'">
                <p-sortIcon class="sort-icon" [field]="col.field"></p-sortIcon>
                <p-columnFilter
                  class="filter-button"
                  *ngIf="col.filterType"
                  [field]="col.field"
                  [type]="col.filterType"
                  display="menu"
                >
                </p-columnFilter>
              </ng-container>
              <ng-container *ngSwitchCase="'date'">
                <p-sortIcon class="sort-icon" [field]="col.field"></p-sortIcon>
                <p-columnFilter
                  class="filter-button"
                  *ngIf="col.filterType"
                  [field]="col.field"
                  [type]="col.filterType"
                  display="menu"
                >
                </p-columnFilter>
              </ng-container>
              <ng-container *ngSwitchCase="'boolean'">
                <p-sortIcon class="sort-icon" [field]="col.field"></p-sortIcon>
                <p-columnFilter
                  class="filter-button"
                  *ngIf="col.filterType"
                  [field]="col.field"
                  [type]="col.filterType"
                  display="menu"
                >
                </p-columnFilter>
              </ng-container>
              <ng-container *ngSwitchCase="'list'">
                <p-sortIcon class="sort-icon" [field]="col.field"></p-sortIcon>
                <p-columnFilter
                  class="filter-button"
                  [field]="col.field"
                  matchMode="in"
                  display="menu"
                  [showMatchModes]="false"
                  [showOperator]="false"
                  [showAddButton]="false"
                >
                  <ng-template
                    pTemplate="filter"
                    let-value
                    let-filter="filterCallback"
                  >
                    <p-multiselect
                      [options]="col.listOptions"
                      placeholder="Any"
                      (onChange)="filterList($event, col.field)"
                      optionLabel="label"
                      [style]="{ 'min-width': '14rem' }"
                      [panelStyle]="{ 'min-width': '16rem' }"
                      [showToggleAll]="true"
                      [showClear]="true"
                    >
                    </p-multiselect>
                  </ng-template>
                </p-columnFilter>
              </ng-container>
              <p-tableHeaderCheckbox
                *ngSwitchCase="'checkbox'"
              ></p-tableHeaderCheckbox>
              <span *ngSwitchCase="'expander'"></span>
              <span *ngSwitchCase="'lineNumber'"></span>
            </ng-container>
          </div>
        </th>
      </tr>
      <tr *ngIf="dataLoader.loading$ | async" class="loading-row">
        <td [attr.colspan]="visibleColumns.length">
          {{ dataLoader.loadingMessage$ | async }}
        </td>
      </tr>
    </ng-template>
  </ng-container>
  <ng-template
    pTemplate="body"
    let-rowData
    let-columns="columns"
    let-rowIndex="rowIndex"
  >
    <tr>
      <td *ngFor="let col of columns">
        <ng-container [ngSwitch]="col.type">
          <p-tableCheckbox
            *ngSwitchCase="'checkbox'"
            [value]="rowData"
            dataKey="id"
          ></p-tableCheckbox>
          <span
            *ngSwitchCase="'string'"
            class="cell-content"
            [pTooltip]="rowData[col.field]"
            >{{ rowData[col.field] }}</span
          >
          <span
            *ngSwitchCase="'date'"
            class="cell-content"
            [pTooltip]="(rowData[col.field] | date: col.dateFormat || 'MM/dd/yyyy') || ''"
            >{{ rowData[col.field] | date: col.dateFormat || 'MM/dd/yyyy' }}</span
          >
          <span
            *ngSwitchCase="'boolean'"
            class="cell-content"
            [pTooltip]="rowData[col.field] ? 'Yes' : 'No'"
            >{{ rowData[col.field] ? 'Yes' : 'No' }}</span
          >
          <span
            *ngSwitchCase="'list'"
            class="cell-content"
            [pTooltip]="rowData[col.field]"
            >{{ rowData[col.field] }}</span
          >
          <span
            *ngSwitchCase="'lineNumber'"
            class="cell-content"
            [pTooltip]="rowIndex + 1"
            >{{ rowIndex + 1 }}</span
          >
          <button
            *ngSwitchCase="'expander'"
            pButton
            [icon]="
              isRowExpanded(rowData)
                ? 'pi pi-chevron-down'
                : 'pi pi-chevron-right'
            "
            [pRowToggler]="rowData"
            class="p-button-text p-button-rounded p-button-plain"
            style="width: 2rem; height: 2rem; padding: 0"
          ></button>
        </ng-container>
      </td>
    </tr>
  </ng-template>
  <ng-template #expandedrow let-rowData>
    <ng-container
      *ngTemplateOutlet="
        expandedRowTemplate || defaultExpandedRow;
        context: { $implicit: rowData }
      "
    ></ng-container>
  </ng-template>
  <ng-template #defaultExpandedRow let-rowData>
    <tr>
      <td [attr.colspan]="visibleColumns.length">
        <div class="p-p-3">
          <p>No expanded row template provided</p>
        </div>
      </td>
    </tr>
  </ng-template>
</p-table>
<p-table
  [columns]="visibleColumns"
  *ngIf="mode === 'group'"
  #pTable
  [resizableColumns]="resizableColumns"
  columnResizeMode="fit"
  [scrollable]="true"
  [scrollHeight]="scrollHeight"
  [showGridlines]="false"
  (onSort)="onHeaderSort($event)"
  (onFilter)="onHeaderFilter($event)"
  (onColResize)="onHeaderColResize($event)"
  [value]="groups"
>
  <ng-container *ngIf="showHeader && !superTableParent">
    <ng-template pTemplate="header" let-columns>
      <tr class="header-row">
        <th
          *ngFor="let col of columns"
          [pSortableColumn]="
            col.type === 'string' ||
            col.type === 'date' ||
            col.type === 'boolean' ||
            col.type === 'list'
              ? col.field
              : undefined
          "
          pResizableColumn
          [style.width]="col.width"
          [style]="col.style"
        >
          <div class="p-d-flex p-jc-between p-ai-center">
            {{ col.header }}
          <ng-container [ngSwitch]="col.type">
            <ng-container *ngSwitchCase="'string'">
              <p-sortIcon [field]="col.field"></p-sortIcon>
              <p-columnFilter
                *ngIf="col.filterType"
                [field]="col.field"
                [type]="col.filterType"
                display="menu"
              >
              </p-columnFilter>
            </ng-container>
            <ng-container *ngSwitchCase="'date'">
              <p-sortIcon [field]="col.field"></p-sortIcon>
              <p-columnFilter
                *ngIf="col.filterType"
                [field]="col.field"
                [type]="col.filterType"
                display="menu"
              >
              </p-columnFilter>
            </ng-container>
            <ng-container *ngSwitchCase="'boolean'">
              <p-sortIcon [field]="col.field"></p-sortIcon>
              <p-columnFilter
                *ngIf="col.filterType"
                [field]="col.field"
                [type]="col.filterType"
                display="menu"
              >
              </p-columnFilter>
            </ng-container>
            <ng-container *ngSwitchCase="'list'">
              <p-sortIcon [field]="col.field"></p-sortIcon>
              <p-columnFilter
                [field]="col.field"
                matchMode="in"
                display="menu"
                [showMatchModes]="false"
                [showOperator]="false"
                [showAddButton]="false"
              >
                <ng-template
                  pTemplate="filter"
                  let-value
                  let-filter="filterCallback"
                >
                  <p-multiselect
                    [options]="col.listOptions"
                    placeholder="Any"
                    (onChange)="filterList($event, col.field)"
                    optionLabel="label"
                    [style]="{ 'min-width': '14rem' }"
                    [panelStyle]="{ 'min-width': '16rem' }"
                    [showToggleAll]="true"
                    [showClear]="true"
                  >
                  </p-multiselect>
                </ng-template>
              </p-columnFilter>
            </ng-container>
            <p-tableHeaderCheckbox
              *ngSwitchCase="'checkbox'"
            ></p-tableHeaderCheckbox>
            <span *ngSwitchCase="'expander'"></span>
            <span *ngSwitchCase="'lineNumber'"></span>
          </ng-container>
        </div>
      </th>
    </tr>
    </ng-template>
  </ng-container>
  <ng-template pTemplate="body" let-rowData>
    <tr class="p-row-odd">
      <td [attr.colspan]="visibleColumns.length">
        <div style="display: flex; align-items: center">
          <span [ngStyle]="getIndentStyle(rowData)"></span>
          <button
            type="button"
            pButton
            class="p-button-text p-button-rounded p-button-plain"
            (click)="onGroupToggle(rowData)"
          >
            <span
              class="group-toggle-icon"
              [class]="
                isGroupExpanded(rowData)
                  ? 'pi pi-chevron-down'
                  : 'pi pi-chevron-right'
              "
            ></span>
          </button>
          <span class="group-name">{{ rowData.name }}</span>
          <span class="group-count">({{ rowData.count }})</span>
        </div>
      </td>
    </tr>
    <tr *ngIf="isGroupExpanded(rowData)">
      <td [attr.colspan]="visibleColumns.length">
        <super-table
          #detailTable
          class="grid-table"
          [dataLoader]="groupLoaders[rowData.name]?.loader"
          [groups]="groupLoaders[rowData.name]?.groups || []"
          [mode]="groupLoaders[rowData.name]?.mode || 'grid'"
          [groupQuery]="groupQuery"
          [columns]="visibleColumns"
          [showRowNumbers]="showRowNumbers"
          [superTableParent]="this"
          [parentKey]="rowData.name"
          [expandedRowTemplate]="expandedRowTemplate"
          [resizableColumns]="resizableColumns"
          [scrollable]="scrollable"
          [scrollHeight]="scrollHeight"
        ></super-table>
      </td>
    </tr>
  </ng-template>
</p-table>
